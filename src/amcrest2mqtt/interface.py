from amcrest import ApiWrapper
from argparse import Namespace
from asyncio import AbstractEventLoop
from datetime import datetime
from logging import Logger
from mqtt_helper import MqttHelper
from paho.mqtt.client import Client, MQTTMessage, ConnectFlags, DisconnectFlags
from paho.mqtt.reasoncodes import ReasonCode
from paho.mqtt.properties import Properties
from types import FrameType
from typing import Protocol, Any, Callable, Coroutine, TypeVar

_T = TypeVar("_T")


class AmcrestServiceProtocol(Protocol):
    api_calls: int
    args: Namespace | None
    amcrest_config: dict[str, Any]
    amcrest_devices: dict[str, dict[str, Any]]
    client_id: str
    config: dict[str, Any]
    device_interval: int
    device_list_interval: int
    devices: dict[str, Any]
    discovery_complete: bool
    events: list
    last_call_date: datetime
    logger: Logger
    loop: AbstractEventLoop
    mqtt_config: dict[str, Any]
    mqtt_connect_time: datetime
    mqtt_helper: MqttHelper
    mqttc: Client
    qos: int
    rate_limited: bool
    running: bool
    service_name: str
    service: str
    storage_update_interval: int
    snapshot_update_interval: int
    states: dict[str, Any]

    async def build_camera(self, device: dict) -> str: ...
    async def build_component(self, device: dict) -> str: ...
    async def build_device_states(self, device_id: str) -> bool: ...
    async def check_event_queue_loop(self) -> None: ...
    async def check_for_events(self) -> None: ...
    async def collect_all_device_events(self) -> None: ...
    async def collect_all_device_snapshots(self) -> None: ...
    async def collect_events_loop(self) -> None: ...
    async def collect_snapshots_loop(self) -> None: ...
    async def connect_to_devices(self) -> dict[str, Any]: ...
    async def device_loop(self) -> None: ...
    async def get_camera(self, host: str) -> ApiWrapper: ...
    async def get_device(self, host: str, device_name: str, index: int) -> None: ...
    async def get_events_from_device(self, device_id: str) -> None: ...
    async def get_ip_address(self, string: str) -> str: ...
    async def get_motion_detection(self, device_id: str) -> bool: ...
    async def get_privacy_mode(self, device_id: str) -> bool: ...
    async def get_snapshot_from_device(self, device_id: str) -> str | None: ...
    async def get_storage_stats(self, device_id: str) -> dict[str, str | float]: ...
    async def handle_device_command(self, device_id: str, handler: str, message: Any) -> None: ...
    async def handle_device_topic(self, components: list[str], payload: Any) -> None: ...
    async def handle_homeassistant_message(self, payload: str) -> None: ...
    async def handle_service_command(self, handler: str, message: Any) -> None: ...
    async def heartbeat(self) -> None: ...
    async def main_loop(self) -> None: ...
    async def mqtt_on_connect(
        self, client: Client, userdata: dict[str, Any], flags: ConnectFlags, reason_code: ReasonCode, properties: Properties | None
    ) -> None: ...
    async def mqtt_on_disconnect(
        self, client: Client, userdata: Any, flags: DisconnectFlags, reason_code: ReasonCode, properties: Properties | None
    ) -> None: ...
    async def mqtt_on_message(self, client: Client, userdata: Any, msg: MQTTMessage) -> None: ...
    async def mqtt_on_subscribe(self, client: Client, userdata: Any, mid: int, reason_code_list: list[ReasonCode], properties: Properties) -> None: ...
    async def mqtt_on_log(self, client: Client, userdata: Any, paho_log_level: int, msg: str) -> None: ...
    async def mqttc_create(self) -> None: ...
    async def process_device_event(self, device_id: str, code: str, payload: Any) -> None: ...
    async def publish_device_availability(self, device_id: str, online: bool = True) -> None: ...
    async def publish_device_discovery(self, device_id: str) -> None: ...
    async def publish_device_state(self, device_id: str, subject: str = "", sub: str = "") -> None: ...
    async def publish_service_availability(self, status: str = "online") -> None: ...
    async def publish_service_discovery(self) -> None: ...
    async def publish_service_state(self) -> None: ...
    async def rediscover_all(self) -> None: ...
    async def refresh_all_devices(self) -> None: ...
    async def set_motion_detection(self, device_id: str, switch: bool) -> None: ...
    async def set_privacy_mode(self, device_id: str, switch: bool) -> None: ...
    async def setup_device_list(self) -> None: ...
    async def store_recording_in_media(self, device_id: str, amcrest_file: str) -> str | None: ...

    def _parse_device_topic(self, components: list[str]) -> list[str | None] | None: ...
    def _wrap_async(
        self,
        coro_func: Callable[..., Coroutine[Any, Any, _T]],
    ) -> Callable[..., None]: ...

    def assert_no_tuples(self, data: Any, path: str = "root") -> None: ...
    def b_to_gb(self, total: int) -> float: ...
    def b_to_mb(self, total: int) -> float: ...
    def classify_device(self, device: dict) -> str: ...
    def get_platform(self, device_id: str) -> str: ...
    def get_component(self, device_id: str) -> dict[str, Any]: ...
    def get_device_availability_topic(self, device_id: str) -> str: ...
    def get_device_image_topic(self, device_id: str) -> str: ...
    def get_device_name(self, device_id: str) -> str: ...
    def get_device_name_slug(self, device_id: str) -> str: ...
    def get_device_state_topic(self, device_id: str, mode_name: str = "") -> str: ...
    def get_mode(self, device_id: str, mode_name: str) -> dict[str, Any]: ...
    def get_modes(self, device_id: str) -> dict[str, Any]: ...
    def get_next_event(self) -> dict[str, Any] | None: ...
    def get_recorded_file(self, device_id: str, file: str, encode: bool = True) -> str | None: ...
    def get_snapshot(self, device_id: str) -> str | None: ...
    def handle_signal(self, signum: int, _: FrameType | None) -> Any: ...
    def heartbeat_ready(self) -> None: ...
    def increase_api_calls(self) -> None: ...
    def is_discovered(self, device_id: str) -> bool: ...
    def is_ipv4(self, string: str) -> bool: ...
    def is_rebooting(self, device_id: str) -> bool: ...
    def list_from_env(self, env_name: str) -> list[str]: ...
    def load_config(self, config_arg: Any | None) -> dict[str, Any]: ...
    def mark_ready(self) -> None: ...
    def mb_to_b(self, total: int) -> int: ...
    def read_file(self, file_name: str) -> str: ...
    def reboot_device(self, device_id: str) -> None: ...
    def restore_state(self) -> None: ...
    def safe_split_device(self, topic: str, segment: str) -> list[str]: ...
    def save_state(self) -> None: ...
    def upsert_device(self, device_id: str, **kwargs: dict[str, Any] | str | int | bool) -> bool: ...
    def upsert_state(self, device_id: str, **kwargs: dict[str, Any] | str | int | bool) -> bool: ...
